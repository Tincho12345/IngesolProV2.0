@{
    Layout = "_Layout";
    ViewData["Title"] = "Presupuesto";
    ViewData["Titles"] = "Presupuestos";
    var ruta = ViewContext.RouteData.Values["controller"]?.ToString() ?? "Materiales";
}
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery AntiforgeryService


<!-- ========================================================================================= -->
<!--                                     🔹 LISTA PRINCIPAL                                    -->
<!-- ========================================================================================= -->

<div class="container-fluid py-2">
     <div class="row mb-1 mb-md-2"></div>

    <div class="row">
        <div class="col-12">

            <!-- Spinner -->
            <div id="spinnerCarga" class="text-center py-4" style="display: none;">
                <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status"></div>
                <div style="margin-top: 1rem; font-weight: bold; font-size: 1.2rem; color: #0d6efd;">
                    Por favor espere<br>
                    CARGANDO lista de Materiales...
                </div>
            </div>

            <!-- Tabla -->
            <div class="table-responsive">
                <table id="tblList" class="table table-striped table-bordered nowrap" style="width:100%">
                    <thead class="table-dark">
                        <tr id="tableHeaders"></tr>
                    </thead>
                </table>
            </div>

        </div>
    </div>
</div>


<!-- ========================================================================================= -->
<!--                         🔹 MODAL: VER ITEMS DEL PRESUPUESTO                              -->
<!-- ========================================================================================= -->
<div class="modal fade" id="modalItemsPresupuesto" tabindex="-1" aria-labelledby="modalItemsPresupuestoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <input type="hidden" id="itemsPresupuestoId" name="presupuestoId" />

        <div class="modal-content">

            <div class="modal-header d-flex flex-column flex-md-row align-items-center justify-content-between w-100"
                 style="background-color:#cce6ff;">

                <h3 class="text-primary mb-2 mb-md-0 text-center mx-md-auto">
                    <i class="fas fa-list-alt"></i>
                    <span id="nombreDinamicoItems"></span>
                </h3>

                <div class="d-flex gap-2 order-md-3">
                    <button id="AddItemPresupuesto" class="btn btn-primary btn-sm" style="color:#000000;">
                        Agregar Items
                    </button>

                    <button id="btnExportarItems" class="btn btn-primary btn-sm" style="color:#000000;">
                        Exportar a Excel
                    </button>
                </div>

                <button type="button" class="btn-close ms-md-3 order-md-4" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="p-3 rounded" style="background-color:#cce6ff;">

                    <div class="table-responsive">
                        <table id="tblItemsPresupuesto" class="table table-hover table-bordered table-sm" style="font-size: 9pt; width:100%">
                            <thead class="table-primary">
                                <tr>
                                    <th style="display: none;">Id</th>                                  
                                    <th>Material</th>
                                    <th>Cod. Barra</th>
                                    <th>Cantidad</th>
                                    <th>UM</th>
                                    <th>Peso Unitario</th>
                                    <th>Foto</th>
                                    <th>Precio Unitario</th>
                                    <th>Total</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>

                        <div class="d-flex justify-content-center align-items-center mt-3">
                            <label class="fw-bold fs-5 me-2 mb-0">Total:</label>
                            <span id="totalGeneralItems" class="fs-4 text-primary">--</span>
                        </div>
                    </div>

                </div>
            </div>

        </div>
    </div>
</div>


<!-- ========================================================================================= -->
<!--                   🔹 MODAL CREAR / EDITAR PRESUPUESTO (Entidad Principal)                -->
<!-- ========================================================================================= -->

<div class="modal fade" id="createEditModal" tabindex="-1" aria-labelledby="createEditModalLabel" aria-hidden="true">
    <div class="modal-dialog">

        <form id="formCrearEditar">
            @Html.AntiForgeryToken()

            <input type="hidden" id="createEditEntityId" name="id" />

            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="createEditModalLabel">Crear/Editar @ViewData["Title"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <!-- Campos dinámicos -->
                <div class="modal-body" id="dynamicFormFields"></div>

                @await Html.PartialAsync("_ModalFooter", "success")
            </div>

        </form>

    </div>
</div>


<!-- ========================================================================================= -->
<!--                       🔹 MODAL CREAR / EDITAR ITEM DEL PRESUPUESTO                       -->
<!-- ========================================================================================= -->
<div class="modal fade modal-lightblue" id="modalCrearItemPresupuesto" tabindex="-1" aria-labelledby="modalCrearItemPresupuestoLabel" aria-hidden="true">
    <div class="modal-dialog modal-xxl-custom">
        <form id="formCrearItemPresupuesto">
            @Html.AntiForgeryToken()

            <div class="modal-content">

                <div class="modal-header justify-content-center position-relative">
                    <button type="button" class="btn-close position-absolute end-0 me-3" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-2 py-1 px-3 rounded d-flex align-items-center justify-content-center"
                         style="background-color:#cce6ff; border-left:6px solid #0d6efd; min-height: 40px;">
                        <i class="fas fa-star text-warning me-2 fs-5"></i>
                        <span class="fw-bold fs-5 text-primary text-center">
                            Selección de Materiales para el Presupuesto
                        </span>
                    </div>
                    <input type="hidden" id="editarItemId" name="Id" />
                    <input type="hidden" id="nuevoItemPresupuestoPresupuestoId" name="PresupuestoId" />
                    <div class="row mt-2">
                        <div class="col-12">
                            <div class="p-2 rounded" style="background-color:#e6f2ff;">

                                <div class="mb-2 d-flex align-items-center gap-2 flex-wrap">

                                    <span class="badge bg-primary small px-2 py-1">
                                        ⭐ Favoritos
                                    </span>

                                    <div class="flex-grow-1" style="max-width: 400px;">
                                        <div class="position-relative">
                                            <input type="text"
                                                   id="filtroFavoritos"
                                                   class="form-control ps-5 pe-5"
                                                   placeholder="Filtrar materiales..."
                                                   autocomplete="off"
                                                   /* Se redujo la altura del input de 40px a 32px * /
                                                   style="background-color:#f0f2f5; border:1px solid #0d6efd; border-radius:20px; height:32px; font-size: 0.9rem;">
                                            <i class="fas fa-search position-absolute text-muted"
                                               style="left:14px; top:50%; transform:translateY(-50%); pointer-events:none; font-size: 0.8rem;"></i>
                                        </div>
                                    </div>

                                    <span class="badge bg-light text-muted fst-italic px-2 py-1"
                                          style="border:1px dashed #0d6efd; max-width: 450px; white-space: normal; font-size: 0.75rem;">
                                        💡 Use "%" para buscar términos (ej: tor%all%cil)
                                    </span>
                                </div>

                                <div class="table-responsive" style="max-height: 45vh; overflow-y: auto;">
                                    <table id="tblItemsFavoritos"
                                           class="table table-hover table-bordered table-sm nowrap"
                                           /* La fuente ya estaba en 9pt, lo mantenemos pero el CSS previo hará el resto * /
                                           style="font-size:9pt; width:100%">
                                        <thead class="table-primary">
                                            <tr>
                                                <th>Cód. Barra</th>
                                                <th style="display:none;">Id</th>
                                                <th>Material</th>
                                                <th>UM</th>
                                                <th class="text-end">Peso</th>
                                                <th class="text-end">Precio</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Cantidad + Precio -->
                    <div class="row mb-3">
                        <div class="col">
                            <label for="cantidadItem" class="form-label">🧮 Cant.</label>
                            <input type="number" step="any" min="0" class="form-control text-end fuente-grande" id="cantidadItem" name="Cantidad" required>
                        </div>
                        <div class="col">
                            <label for="pesoUnitarioItem" class="form-label">⚖️ Unit.</label>
                            <input type="number" step="any" min="0" class="form-control text-end fuente-grande" id="pesoUnitarioItem" name="PesoUnitario">
                        </div>
                        <div class="col">
                            <label for="precioUnitarioItem" class="form-label">💰 Unit.</label>
                            <input type="number" step="any" min="0" class="form-control text-end fuente-grande" id="precioUnitarioItem" name="PrecioUnitario" required>
                        </div>
                    </div>

                    <!-- Buscador ancho completo -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <label for="materialInput" class="form-label">Material</label>

                            <div class="position-relative">
                                <input type="text"
                                       id="materialInput"
                                       class="form-control ps-5 pe-5"
                                       placeholder="Buscar material..."
                                       autocomplete="off"
                                       style="background-color: #f0f2f5; border: none; border-radius: 20px; height: 40px;" />

                                <i class="fas fa-search position-absolute text-muted"
                                   style="left: 14px; top: 50%; transform: translateY(-50%);"></i>

                                <button type="button"
                                        id="clearMaterialInput"
                                        class="btn position-absolute p-0 bg-transparent"
                                        style="right: 14px; top: 50%; transform: translateY(-50%); display: none;">
                                    <i class="fas fa-times text-secondary"></i>
                                </button>

                                <div id="sugerenciasMateriales"
                                     class="list-group position-absolute bg-white border shadow-sm rounded-3"
                                     style="top:105%; width:calc(100% - 15px); display:none; z-index:2000; max-height:250px; overflow-y:auto;">
                                </div>
                            </div>

                            <div class="text-muted small fst-italic mt-2">
                                💡 Puede escribir partes de la palabra separadas por "%" para búsquedas parciales.
                            </div>
                            <!-- Total abajo -->
                            <div class="row mb-3">
                                <div class="col-12 d-flex justify-content-end align-items-center gap-2">
                                    <span class="fw-bold fs-5">Total:</span>
                                    <span id="totalItemLabel" class="fs-4 text-primary">$ 0,00</span>
                                </div>
                            </div>
                            <input type="hidden" id="materialIdSeleccionado" name="materialIdSeleccionado" />
                        </div>
                    </div>
                </div>
                @await Html.PartialAsync("_ModalFooter", "success")
            </div>
        </form>

    </div>
</div>

<!-- ========================================================================================= -->
<!--                                         🔹 SCRIPTS                                       -->
<!-- ========================================================================================= -->
@section Scripts {
    <script>
        window._ruta = '@ruta';
        window._mostrarColumnasDefault = false;
        window._viewTitle = '@ViewData["Title"]';
        window._viewTitles = '@ViewData["Titles"]';
        window._viewIcon = "fas fa-clipboard-list";
        window._mostrarBotonContactos = true;
        window._viewIconAux = 'fas fa-dollar-sign';
        window._mensaje = 'Ver Items del Presupuesto';

        window._columnasPersonalizadas = [
            { data: 'ordenId', label: 'Nº Orden - Nombre - Descripción', type: 'search-youtube', includeInForm: true, includeInTable: false },
            { data: 'numeroOrden', label: 'Nº Orden', type: 'string', includeInForm: false, includeInTable: true },
            { data: 'plantaNombre', label: 'Planta Industrial', type: 'string', includeInForm: false, includeInTable: true },
            { data: 'areaNombre', label: 'Area', type: 'string', includeInForm: false, includeInTable: true },
            { data: 'nombre', label: 'Nombre del Presupuesto', type: 'string', includeInForm: true, includeInTable: true },
            { data: 'descripcion', label: 'Descripción', type: 'string', includeInForm: true, includeInTable: true },
            { data: 'total', label: 'Total Presupuesto', type: 'decimal', includeInForm: false, includeInTable: true, render: data => data != null ? data.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' }) : '', className: 'text-end fuente-grande' }
        ];
    </script>

    <script>
        ['cantidadItem', 'precioUnitarioItem'].forEach(id => {
            document.getElementById(id).addEventListener('keydown', function (event) {
                if (event.key === '-' || event.key === 'Subtract') event.preventDefault();
            });
        });
    </script>

    <script type="module" src="/js/main.js"></script>
    <script src="/js/itemsPresupuesto.js"></script>
}
